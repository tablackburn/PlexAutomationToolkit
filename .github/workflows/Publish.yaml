name: Publish to PowerShell Gallery

on:
  release:
    types: [published]

jobs:
  publish:
    name: Publish Module
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Module
        shell: pwsh
        run: ./build.ps1 -Task Build -Bootstrap

      - name: Get Module Path
        id: module-path
        shell: pwsh
        run: |
          $modulePath = Get-ChildItem -Path ./Output/PlexAutomationToolkit -Directory |
            Sort-Object Name -Descending |
            Select-Object -First 1 -ExpandProperty FullName
          "path=$modulePath" >> $env:GITHUB_OUTPUT

      - name: Publish to PowerShell Gallery
        uses: natescherer/publish-powershell-action@v1
        with:
          token: ${{ secrets.PSGALLERY_API_KEY }}
          target: gallery
          path: ${{ steps.module-path.outputs.path }}
